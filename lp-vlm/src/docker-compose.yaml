services:
  lp-consumer:
    container_name: lp-consumer
    build:
      context: .
      dockerfile: Dockerfile.consumer
    restart: always
    environment:
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - LP_IP=${LP_IP}
      - VIDEO_NAME=${VIDEO_NAME}
      - LP_BASE_DIR=${LP_BASE_DIR}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_MANAGEMENT_PORT=15672
      - no_proxy=rabbitmq,minio-service,vlm-service,model-downloader,localhost,127.0.0.1
      - AMQP_NOTE=Use nc rabbitmq 5672 (curl is not valid for AMQP)
    volumes:
      - .:/app
    networks:
      - my_network

  vlm-pipeline-runner:
    container_name: vlm-pipeline-runner
    build:
      context: ../..
      dockerfile: docker/Dockerfile.pipeline
      args:
        - HTTP_PROXY=${HTTP_PROXY}
        - HTTPS_PROXY=${HTTPS_PROXY}
    image: pipeline-runner:lp
    environment:
      - VIDEO_NAME=${VIDEO_NAME}
      - LP_IP=${LP_IP}
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - THRESHOLD=${THRESHOLD:-16}
      - DISPLAY=${DISPLAY:-:0}
      - RENDER_MODE=${RENDER_MODE:-0}
      - DETECTION_THRESHOLD=${DETECTION_THRESHOLD}
      - LP_BASE_DIR=${LP_BASE_DIR}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_MANAGEMENT_PORT=15672
      - no_proxy=rabbitmq,minio-service,vlm-service,model-downloader,localhost,127.0.0.1
      - AMQP_NOTE=Use nc rabbitmq 5672 (curl is not valid for AMQP)
    volumes:
      - ../src/pipeline/publish.py:/home/pipeline-server/lp-vlm/gvapython/publish.py
      - ../src/pipeline/send_end_message.py:/home/pipeline-server/lp-vlm/gvapython/send_end_message.py
      - ../src/pipeline/config.py:/home/pipeline-server/lp-vlm/gvapython/config.py
      - ../src/utils/save_results.py:/home/pipeline-server/lp-vlm/save_results.py
      - ../../models:/home/pipeline-server/lp-vlm/models
      - ../../performance-tools/sample-media:/home/pipeline-server/lp-vlm/sample-media
      - ${VLM_RESULTS_DIR:-../vlm-results}:/app/results            
      - /dev:/dev
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    networks:
      - my_network
    privileged: true
    depends_on:
      - lp-consumer        # <-- correct indentation and syntax


networks:
  my_network:
    external: true
    name: my_network